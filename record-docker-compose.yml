version: "3.7"

services:
  influxdb:
    deploy:
        resources:
            limits:
                memory: 4G
    image: influxdb
    env_file:
      - ./.env.prod

    ports:
    - 0.0.0.0:28953:8086

    volumes:
      - "./influxdb.conf:/etc/influxdb/influxdb.conf"
      - "${HOME}/influxdb:/var/lib/influxdb"

    command: influxd -config /etc/influxdb/influxdb.conf

  bitmex-xbtusd:
    image: codequants.com:5000/exchange-data
    network_mode: bridge
    extra_hosts:
      - "redis:172.18.0.1"
      - "influxdb:172.18.0.1"
    env_file:
      - ./.env.prod
    depends_on:
      - influxdb
    command: bash -c "source ~/.bashrc && python ./exchange_data/recorders/_bitmex.py XBTUSD"

  bitstamp-btcusd:
    image: codequants.com:5000/exchange-data
    env_file:
      - ./.env.prod
    extra_hosts:
      - "influxdb:172.18.0.1"
    environment:
      - BATCH_SIZE=100

    depends_on:
      - influxdb

    command: bash -c "source ~/.bashrc && ./exchange-data --exchange bitstamp btcusd"

  gdax-btcusd:
    image: codequants.com:5000/exchange-data
    env_file:
      - ./.env.prod
    extra_hosts:
      - "influxdb:172.18.0.1"
    environment:
      - BATCH_SIZE=100

    depends_on:
      - influxdb

    command: bash -c "source ~/.bashrc && ./exchange-data --exchange gdax BTC-USD"
